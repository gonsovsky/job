
# Инфраструктура транспорта

## Предистория

В текущем исполнении у нас была некая 4-ёх звенная схема транспортировки данных.
Агент с помощью Health отправлял данные на Dhu, данные на Dhu обрабатывались Dpu и складывались в БД, интерфейс обращался к БД за данными.
Изначально планировали заменить данную схему на 3-ёх звенную схему в которой данные отсылались агентом на сервера обработки и сразу обрабатывались и складывались в бд "налету". Основной проблемой данного варианта была сложность написания кода компонентов которые будут "предоставлять" наборы данных для последующей отсылки на сервер (dataprovider-ы). Возникали проблемы разбиения данных на завершённые куски которые можно передавать на сервер - код разбиения требовалось (так как только они знают что за данные и в каком формате они будут передаваться) описывать в dataprovider-ах, а это код который не относится к бизнес логике. Также возникали проблемы при разбиении крупных данных на составляющие часть которые потребуется обработать на лету на сервере. Для абстрактного примера - у нас есть некоторое строковое свойство и данная строка занимает 100 мб, а размер пакета у нас подобран 10 мб, компоненты которые будет бить данную строку на части на агенте и компоненты на сервере которые будут обновлять по данным частям какую-то колонку в бд "налету" в любых обозримых нами вариантах представлялись относительно сложными и излишними.
Поэтому следующая предлагаемая схема предпалагала сохранения данных в некоторые пакеты (файлы) на агенте, их последующей отправки на сервера по частям, и обработке при завершении передачи файла. Изначально обработку можно было произвести сразу на сервере принимающем данные при завершении загрузки файла или использовать инфраструктуру которая будет записывать данные о загруженных файлах а отдельные обработчики будут их обрабатывать.
Основные проблемы первого варианта (сразу запускать обработку после загрузки на томже сервере) это сложности с определением предполагаемой нагрузки и распределением нагрузки (на бд в частности), поэтому был выбран второй вариант.

## Цели новой инфраструктуры и проблемы текущей схемы

Новая инфраструктура транспорта (для доставки данных до интерфейса и получения конфигураций агента) потребовалась для решения нескольких проблем и добавления новых функций.

Вот часть из них:

1. У администраторов есть желание/потребность настраивать временные промежутки в которые агентам разрешено отправлять/получать данные (регулирование нагрузки).
2. У администраторов есть желание/потребность настраивать размеры сообщений которыми агент обменивается с сервером для регулирования нагрузки на сеть (в предыдущей реализации использовались частые маленькие атомарные http запросы для получения конфигурационных данных, которые вызывали сильную нагрузки на сетевое оборудование).
3. Есть желание более быстрой реакции от интерфейса (например, как отправили данные с агента, так они сразу и появились в интефейсе) и более прозрачного статуса (и кода) того доставлены данные или нет (Эта проблема не была решена полностью).
4. Проблемы настройки Dhu, Dpu в их текущей реализации (нет хорошего представления о том как их настраивать и их внутреннем устройстве).
5. Проблемы реализации своих блокировок для dhu, на dpu обработка идёт единичными событиями, каждый dpu обрабатывает свой dhu.
6. Проблема сложности инфраструктуры dhu. При возникновении ошибок в работе DHU их часто довольно сложно диагностировать и решать.

Проблемы выявленные при проектировании новой инфраструктуры

1. В текущей реализации не совсем понятно как агент может распределять части данных между dhu и как dpu будут их обрабатывать если каждый dpu обрабатывает конкретный dhu (есть идеи с роутингом среди dhu, но мы уже пошли на новую реализаци в которой он не нужен).
2. В текущей реализации не до конца понятно как распределять нагрузку между файловыми шарами на которых расположены контейнеры (т.е. требуется реализация).
3. 

## Новая инфраструктура транспорта

Состоит (в представлении на текущий момент, пока идёт её разработка) из агентской части, серверной части приёма данных и серверной части обработки данных.

Агент накапливает данные поставляемые провайдерами данных в виде файлов/пакетов. Сервис отправки периодически отправляет файлы (или часть файла) на сервер приёма данных, данные отправляются с учётом лимитов на размеры сообщений и максимального таймаута для накопления минимального размера данных. 

Сервер либо принимает запрос и 
1. С помощью механизма тротлинга определяет что сервер сейчас загружен и отвечает с http status 429 и хедером Retry-After с указанием таймаута ожидания.
2. Сохраняет файл\файлы\части файлов на сервер mongodb (рассматривали вариант файловой шары, но он оказался непроизводительным).

Dpu обрабатывает файлы на основе предоставляыемых mongodb данных и разрешает конкурентность на пачку файлов\пакетов с помощью update-ов применяемых к документам в mongodb.
Для обеспечения надёжности при потере одного Dpuб задачи "назначченные" на него будут "переназначены" после истечения определённого срока.

Проблема тротлинга при скрытии dhu за маршрутизацией!
